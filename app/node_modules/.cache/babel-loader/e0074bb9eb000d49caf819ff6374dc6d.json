{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getOwnedAccountsFilters = exports.parseMintData = exports.parseTokenAccountData = exports.MINT_LAYOUT = exports.ACCOUNT_LAYOUT = exports.getOwnedTokenAccounts = void 0;\n\nconst web3_js_1 = require(\"@solana/web3.js\");\n\nconst serum_1 = require(\"@project-serum/serum\");\n\nconst bs58 = __importStar(require(\"bs58\"));\n\nconst BufferLayout = __importStar(require(\"buffer-layout\"));\n\nasync function getOwnedTokenAccounts(connection, publicKey) {\n  let filters = getOwnedAccountsFilters(publicKey); // @ts-ignore\n\n  let resp = await connection._rpcRequest('getProgramAccounts', [serum_1.TokenInstructions.TOKEN_PROGRAM_ID.toBase58(), {\n    commitment: connection.commitment,\n    filters\n  }]);\n\n  if (resp.error) {\n    throw new Error('failed to get token accounts owned by ' + publicKey.toBase58() + ': ' + resp.error.message);\n  }\n\n  return resp.result // @ts-ignore\n  .map(({\n    pubkey,\n    account: {\n      data\n    }\n  }) => {\n    data = bs58.decode(data);\n    return {\n      publicKey: new web3_js_1.PublicKey(pubkey),\n      account: parseTokenAccountData(data)\n    };\n  });\n}\n\nexports.getOwnedTokenAccounts = getOwnedTokenAccounts; // todo: remove\n\nexports.ACCOUNT_LAYOUT = BufferLayout.struct([BufferLayout.blob(32, 'mint'), BufferLayout.blob(32, 'owner'), BufferLayout.nu64('amount'), BufferLayout.blob(93)]);\nexports.MINT_LAYOUT = BufferLayout.struct([BufferLayout.blob(44), BufferLayout.u8('decimals'), BufferLayout.blob(37)]);\n\nfunction parseTokenAccountData(data) {\n  // @ts-ignore\n  let {\n    mint,\n    owner,\n    amount\n  } = exports.ACCOUNT_LAYOUT.decode(data);\n  return {\n    mint: new web3_js_1.PublicKey(mint),\n    owner: new web3_js_1.PublicKey(owner),\n    amount\n  };\n}\n\nexports.parseTokenAccountData = parseTokenAccountData; // @ts-ignore\n\nfunction parseMintData(data) {\n  // @ts-ignore\n  let {\n    decimals\n  } = exports.MINT_LAYOUT.decode(data);\n  return {\n    decimals\n  };\n}\n\nexports.parseMintData = parseMintData; // @ts-ignore\n\nfunction getOwnedAccountsFilters(publicKey) {\n  return [{\n    memcmp: {\n      // @ts-ignore\n      offset: exports.ACCOUNT_LAYOUT.offsetOf('owner'),\n      bytes: publicKey.toBase58()\n    }\n  }, {\n    dataSize: exports.ACCOUNT_LAYOUT.span\n  }];\n}\n\nexports.getOwnedAccountsFilters = getOwnedAccountsFilters;","map":{"version":3,"sources":["../../src/token.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getOwnedAccountsFilters = exports.parseMintData = exports.parseTokenAccountData = exports.MINT_LAYOUT = exports.ACCOUNT_LAYOUT = exports.getOwnedTokenAccounts = void 0;\nconst web3_js_1 = require(\"@solana/web3.js\");\nconst serum_1 = require(\"@project-serum/serum\");\nconst bs58 = __importStar(require(\"bs58\"));\nconst BufferLayout = __importStar(require(\"buffer-layout\"));\nasync function getOwnedTokenAccounts(connection, publicKey) {\n    let filters = getOwnedAccountsFilters(publicKey);\n    // @ts-ignore\n    let resp = await connection._rpcRequest('getProgramAccounts', [\n        serum_1.TokenInstructions.TOKEN_PROGRAM_ID.toBase58(),\n        {\n            commitment: connection.commitment,\n            filters,\n        },\n    ]);\n    if (resp.error) {\n        throw new Error('failed to get token accounts owned by ' +\n            publicKey.toBase58() +\n            ': ' +\n            resp.error.message);\n    }\n    return (resp.result\n        // @ts-ignore\n        .map(({ pubkey, account: { data } }) => {\n        data = bs58.decode(data);\n        return {\n            publicKey: new web3_js_1.PublicKey(pubkey),\n            account: parseTokenAccountData(data),\n        };\n    }));\n}\nexports.getOwnedTokenAccounts = getOwnedTokenAccounts;\n// todo: remove\nexports.ACCOUNT_LAYOUT = BufferLayout.struct([\n    BufferLayout.blob(32, 'mint'),\n    BufferLayout.blob(32, 'owner'),\n    BufferLayout.nu64('amount'),\n    BufferLayout.blob(93),\n]);\nexports.MINT_LAYOUT = BufferLayout.struct([\n    BufferLayout.blob(44),\n    BufferLayout.u8('decimals'),\n    BufferLayout.blob(37),\n]);\nfunction parseTokenAccountData(data) {\n    // @ts-ignore\n    let { mint, owner, amount } = exports.ACCOUNT_LAYOUT.decode(data);\n    return {\n        mint: new web3_js_1.PublicKey(mint),\n        owner: new web3_js_1.PublicKey(owner),\n        amount,\n    };\n}\nexports.parseTokenAccountData = parseTokenAccountData;\n// @ts-ignore\nfunction parseMintData(data) {\n    // @ts-ignore\n    let { decimals } = exports.MINT_LAYOUT.decode(data);\n    return { decimals };\n}\nexports.parseMintData = parseMintData;\n// @ts-ignore\nfunction getOwnedAccountsFilters(publicKey) {\n    return [\n        {\n            memcmp: {\n                // @ts-ignore\n                offset: exports.ACCOUNT_LAYOUT.offsetOf('owner'),\n                bytes: publicKey.toBase58(),\n            },\n        },\n        {\n            dataSize: exports.ACCOUNT_LAYOUT.span,\n        },\n    ];\n}\nexports.getOwnedAccountsFilters = getOwnedAccountsFilters;\n//# sourceMappingURL=token.js.map"]},"metadata":{},"sourceType":"script"}